# Azure DevOps Pipeline: Build, Push, and Verify Docker Image (SP-only, fixed)
trigger:
- master

variables:
  # Azure Container Registry (ACR)
  containerRegistry: 'aksdevopsacr1.azurecr.io'
  imageRepository: 'vivekgnambiarazuredevopsgithubacraksapp'
  dockerfilePath: '$(Build.SourcesDirectory)/Git-Repository-files/Dockerfile'
  dockerBuildContext: '$(Build.SourcesDirectory)/Git-Repository-files'
  tag: '$(Build.BuildId)'

  # Azure subscription service connection
  azureSubscription: 'AzureDevOps-Subscription-01'

  # Agent VM
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build, Push, and Verify Docker Image
  jobs:
  - job: Build
    displayName: Build Job
    pool:
      vmImage: $(vmImageName)
    steps:

    # -----------------------------
    # 1. List local Docker images
    # -----------------------------
    - script: docker images
      displayName: List Docker Images

    # -----------------------------
    # 2. Build Docker image
    # -----------------------------
    - script: |
        docker build \
          -t $(containerRegistry)/$(imageRepository):$(tag) \
          -t $(containerRegistry)/$(imageRepository):latest \
          -f $(dockerfilePath) \
          $(dockerBuildContext)
      displayName: Build Docker Image

    # -----------------------------
    # 3. Login to ACR via SP token
    # -----------------------------
    - task: AzureCLI@2
      displayName: 'Login to ACR via Service Principal Token'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          acrName=$(echo "$(containerRegistry)" | cut -d '.' -f1)
          echo "Logging in to ACR: $acrName via SP token"

          # Get SP AppId
          SP_APP_ID=$(az account show --query user.name -o tsv)

          # Get short-lived ACR token
          TOKEN=$(az acr login --name $acrName --expose-token --query accessToken -o tsv)

          # Login Docker CLI
          echo $TOKEN | docker login $acrName --username $SP_APP_ID --password-stdin
          echo "âœ… Docker CLI logged in successfully"

    # -----------------------------
    # 4. Optional: Wait for Role Propagation
    # -----------------------------
    - script: |
        acrName=$(echo "$(containerRegistry)" | cut -d '.' -f1)
        for i in {1..6}; do
          if az acr repository list --name $acrName --output tsv >/dev/null 2>&1; then
              echo "SP has access to ACR"
              break
          else
              echo "SP does not have access yet, sleeping 10s..."
              sleep 10
          fi
        done
      displayName: Wait for Role Propagation (Optional)

    # -----------------------------
    # 5. Push Docker image to ACR
    # -----------------------------
    - script: |
        echo ">>> Pushing image with tag: $(tag)"
        docker push $(containerRegistry)/$(imageRepository):$(tag)

        echo ">>> Pushing image with tag: latest"
        docker push $(containerRegistry)/$(imageRepository):latest
      displayName: Push Docker Image to ACR

    # -----------------------------
    # 6. Verify image exists in ACR
    # -----------------------------
    - task: AzureCLI@2
      displayName: Verify Docker Image in ACR
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          acrName=$(echo "$(containerRegistry)" | cut -d '.' -f1)
          echo ">>> Checking repository $(imageRepository) for pushed tags..."
          tags=$(az acr repository show-tags --name $acrName --repository $(imageRepository) --output tsv)

          echo ">>> Found tags: $tags"
          if [[ ! " $tags " =~ " $(tag) " ]]; then
              echo ">>> ERROR: Image $(imageRepository):$(tag) not found in ACR!"
              exit 1
          fi
          echo ">>> Image $(imageRepository):$(tag) verified successfully."
