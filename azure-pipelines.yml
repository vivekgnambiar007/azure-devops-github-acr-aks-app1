# Azure DevOps Pipeline: Build, Push, and Verify Docker Image to ACR (az acr build)

trigger:
- master

variables:
  acrName: 'aksdevopsacr1'
  imageRepository: 'vivekgnambiarazuredevopsgithubacraksapp'
  dockerfilePath: 'Git-Repository-files/Dockerfile'
  dockerBuildContext: 'Git-Repository-files'
  tag: '$(Build.BuildId)'
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and Push Docker Image with az acr build
  jobs:
  - job: Build
    displayName: Build Job
    pool:
      vmImage: $(vmImageName)
    steps:

    # -----------------------------
    # 1. Build & Push using az acr build
    # -----------------------------
    - task: AzureCLI@2
      displayName: Build & Push Docker Image to ACR
      inputs:
        azureSubscription: 'AzureDevOps-Subscription-01'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -x  # Enable shell tracing

          echo "üîë Logging into ACR (debug)..."
          az acr login --name $(acrName) --debug

          echo "üì¶ Building & pushing image via Azure ACR Tasks..."
          az acr build \
            --registry $(acrName) \
            --image $(imageRepository):$(tag) \
            --image $(imageRepository):latest \
            --file $(dockerfilePath) \
            $(dockerBuildContext) \
            --no-logs \
            --debug

    # -----------------------------
    # 2. Verify image exists in ACR
    # -----------------------------
    - task: AzureCLI@2
      displayName: Verify Docker Image in ACR
      inputs:
        azureSubscription: 'AzureDevOps-Subscription-01'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -x  # Enable shell tracing
          echo "üîç Checking pushed image tags in ACR..."
          tags=$(az acr repository show-tags --name $(acrName) --repository $(imageRepository) -o tsv --debug)
          echo ">>> Found tags: $tags"
          if [[ ! " $tags " =~ " $(tag) " ]]; then
              echo "‚ùå ERROR: Image $(imageRepository):$(tag) not found in ACR!"
              exit 1
          fi
          echo "‚úÖ Image $(imageRepository):$(tag) verified successfully."
