# Azure DevOps Pipeline: Build and Push Docker Image via AzureCLI
trigger:
- master

variables:
  # Azure Container Registry
  azureSubscription: 'AzureDevOps-Subscription-01'   # AzureRM service connection
  acrName: 'aksdevopsacr1'
  imageRepository: 'vivekgnambiarazuredevopsgithubacraksapp'
  dockerfilePath: '$(Build.SourcesDirectory)/Git-Repository-files/Dockerfile'
  dockerBuildContext: '$(Build.SourcesDirectory)/Git-Repository-files'
  tag: '$(Build.BuildId)'

  # Agent VM
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build, Push, and Verify Docker Image
  jobs:
  - job: Build
    displayName: Build Job
    pool:
      vmImage: $(vmImageName)
    steps:

    # -----------------------------
    # 1. Login to ACR
    # -----------------------------
    - task: AzureCLI@2
      displayName: 'Login to ACR'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "üîë Logging into ACR $(acrName)..."
          az acr login --name $(acrName)

    # -----------------------------
    # 2. Build Docker image
    # -----------------------------
    - task: AzureCLI@2
      displayName: 'Build Docker Image'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "üèó Building Docker image..."
          docker build \
            -f $(dockerfilePath) \
            -t $(acrName).azurecr.io/$(imageRepository):$(tag) \
            -t $(acrName).azurecr.io/$(imageRepository):latest \
            $(dockerBuildContext)

    # -----------------------------
    # 3. Push Docker image
    # -----------------------------
    - task: AzureCLI@2
      displayName: 'Push Docker Image to ACR'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "üöÄ Pushing Docker image to ACR..."
          docker push $(acrName).azurecr.io/$(imageRepository):$(tag)
          docker push $(acrName).azurecr.io/$(imageRepository):latest

    # -----------------------------
    # 4. Verify Docker image
    # -----------------------------
    - task: AzureCLI@2
      displayName: 'Verify Docker Image in ACR'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "üîç Verifying image exists in ACR..."
          tags=$(az acr repository show-tags \
                  --name $(acrName) \
                  --repository $(imageRepository) \
                  --output tsv)

          echo ">>> Found tags: $tags"
          if [[ ! " $tags " =~ " $(tag) " ]]; then
              echo "‚ùå ERROR: Image $(imageRepository):$(tag) not found in ACR!"
              exit 1
          fi

          echo "‚úÖ Image $(imageRepository):$(tag) verified successfully."
